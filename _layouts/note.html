---
layout: default
---

<article class="note">
  <header style="position: relative;">
    <a href="{{ "/" | relative_url }}">{{ site.theme_config.back_home_text }}</a>
    <h1>{{ page.title }}</h1>
    <p class="meta">{{ page.date | date: "%B %d, %Y" }}</p>

  <!-- Note about AI summary (click to smooth-scroll to summary) -->
  <div class="ai-summary-note"><a href="#ai-summary-section">AI summary available at the end of the page</a></div>
  </header>

  <div class="content">
    {{ content }}
  </div>

  {% if page.backlinks %}
  <div class="backlinks">
    <h3>Links to this note</h3>
    <ul>
      {% for backlink in page.backlinks %}
      <li><a href="{{ backlink.url }}">{{ backlink.title }}</a></li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- AI Summary Button -->
  <div id="ai-summary-section" class="ai-summary-container" style="margin: 2rem 0;">
    <button id="ai-summary-btn">Click to get AI summary</button>
    <div id="ai-summary-result"></div>
  </div>
</article>

<style>
  /* Top note styles */
  .ai-summary-note {
    position: absolute;
    top: 0;
    right: 0;
    font-size: 0.95rem;
    color: var(--text-secondary);
  }
  html[data-theme="dark"] .ai-summary-note { color: var(--links); opacity: 0.9; }
  .ai-summary-note a { color: inherit; text-decoration: none; }
  .ai-summary-note a:hover { text-decoration: underline; }
  @media (max-width: 640px) {
    .ai-summary-note {
      position: static;
      display: block;
      margin-top: 0.5rem;
      text-align: left;
    }
  }

  /* Button styles with theme-aware colors */
  #ai-summary-btn {
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
    transition: filter 0.2s ease, background-color 0.2s ease;
    background-color: #4CAF50; /* Light theme default */
  }
  #ai-summary-btn:hover { filter: brightness(0.95); }
  html[data-theme="dark"] #ai-summary-btn { background-color: var(--links); }
  html[data-theme="dark"] #ai-summary-btn:hover { filter: brightness(1.1); }

  /* Result box (theme-aware) */
  #ai-summary-result {
    background-color: var(--bg-secondary);
    color: var(--text);
    border-left: 4px solid #4CAF50; /* Light theme accent */
    padding: 12px;
    margin-top: 1rem;
    border-radius: 6px;
    font-style: italic;
    white-space: pre-wrap; /* preserve newlines */
  }
  html[data-theme="dark"] #ai-summary-result {
    background-color: var(--bg-secondary);
    color: var(--text);
    border-left-color: var(--links); /* Dark theme accent */
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Smooth-scroll from header note to AI summary section
  const jumpLink = document.querySelector('.ai-summary-note a');
  if (jumpLink) {
    jumpLink.addEventListener('click', (e) => {
      const target = document.getElementById('ai-summary-section');
      if (target) {
        e.preventDefault();
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  }

  // Convert any literal fenced code blocks that failed markdown parsing into real <pre><code> blocks
  function renderFencedCode(container) {
    if (!container) return;
    if (container.getAttribute('data-fences-processed') === 'true') return;
    const blocks = Array.from(container.querySelectorAll('p, li, blockquote'));
    for (const p of blocks) {
      const text = p.textContent || '';
      if (!text.includes('```')) continue;

      const lines = text.split(/\r?\n/);
      const frag = document.createDocumentFragment();
      let inCode = false;
      let codeLang = '';
      let codeLines = [];
      let transformed = false;

      for (const line of lines) {
        const fence = line.match(/^```(.*)$/);
        if (fence) {
          // Toggle code block
          if (!inCode) {
            inCode = true;
            transformed = true;
            const info = (fence[1] || '').trim();
            codeLang = (info.split(/\s+/)[0] || '').toLowerCase(); // first token as language
            codeLines = [];
          } else {
            // closing fence -> emit block
            inCode = false;
            const pre = document.createElement('pre');
            pre.className = 'highlight';
            const code = document.createElement('code');
            code.className = (codeLang ? `language-${codeLang} ` : '') + 'highlighter-rouge';
            code.textContent = codeLines.join('\n');
            pre.appendChild(code);
            frag.appendChild(pre);
            codeLang = '';
            codeLines = [];
          }
          continue;
        }

        if (inCode) {
          codeLines.push(line);
        } else {
          // normal text outside code
          frag.appendChild(document.createTextNode(line));
          frag.appendChild(document.createElement('br'));
        }
      }

      if (transformed) {
        const wrapper = document.createElement('div');
        wrapper.appendChild(frag);
        p.replaceWith(wrapper);
      }
    }
    container.setAttribute('data-fences-processed', 'true');
  }

  renderFencedCode(document.querySelector('.content'));

  const btn = document.getElementById("ai-summary-btn");
  const resultDiv = document.getElementById("ai-summary-result");

  if (!btn) return;

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    btn.textContent = "Generating summary...";
    resultDiv.textContent = "";

    try {
      // Determine function base. If hosted on Netlify, /.netlify/functions works.
      // If hosted on GitHub Pages (with a subpath), the function must be absolute via your Netlify site URL.
      // You can set window.NETLIFY_FUNCTIONS_BASE in _includes/custom_head.html to override when needed.
      const base = window.NETLIFY_FUNCTIONS_BASE || "";
      const fnUrl = (base ? base.replace(/\/$/, "") : "") + "/.netlify/functions/summarize";

      const response = await fetch(fnUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: document.querySelector(".content").innerText
        }),
      });

      const data = await response.json();

      if (response.ok && data.summary) {
        // Insert summary safely as text and optionally include first image from the note
        resultDiv.innerHTML = "";
        const firstImg = document.querySelector('.content img');
        if (firstImg) {
          try {
            const clone = firstImg.cloneNode(true);
            clone.loading = 'lazy';
            clone.decoding = 'async';
            clone.style.marginBottom = '0.5rem';
            resultDiv.appendChild(clone);
          } catch (e) { /* ignore */ }
        }
        const textEl = document.createElement('div');
        textEl.textContent = data.summary;
        resultDiv.appendChild(textEl);
        if (window.MathJax && window.MathJax.typesetPromise) {
          window.MathJax.typesetPromise([resultDiv]).catch(e => console.error('MathJax typeset error', e));
        }
      } else {
        resultDiv.textContent = "Error generating summary: " + (data.error || "Unknown");
        console.error("AI summary error", { status: response.status, data });
      }
    } catch (err) {
      console.error(err);
      resultDiv.textContent = "Error generating summary.";
    } finally {
      btn.disabled = false;
      btn.textContent = "Click to get AI summary";
    }
  });
});
</script>
